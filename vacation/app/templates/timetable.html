{% extends 'base.html' %}

{% block css %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'timetableStyle.css' %}"/>
{% endblock css %}

{% block content %}
<div class="signinBox">
    <a href=""><button class="signinBtn">ë‚´ ê³„íší‘œ ë§Œë“¤ê¸°</button></a>
</div>
<div class="planCircleBox">
    <canvas id="planCanvas" width="380" height="400"></canvas>
    <input type="text" id="detailInput" placeholder="í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    <button id="addButton">ì¶”ê°€</button>
    <select id="colorSelect"></select>
</div>
<div class="makePlan">
    <div class="makePlanBox">
        <a href=""><button class="makePlanBtn">{{ username }}ì˜ ê³„íší‘œ ì§œì£¼ê¸°</button></a>
    </div>
</div>
<div class="planList">
    <div class="planListBox">
        <a href=""><button class="planListBtn">{{ username }}ì˜ ê³„íší‘œ í‰ê°€í•˜ê¸°</button></a>
    </div>
</div>
<div class="modal hidden">
  <div class="modal_content">
    <div class="modal_box">
      <h2>ê³„íší‘œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
      <img src=""/>
      <p>ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì´ ë§ì¹œ {{ username }} ê³„íší‘œë„ ë³´ëŸ¬ê°ˆê¹Œìš”~?</p>
      <a href="http://127.0.0.1:8000/tablelist/{{ timetable.pk }}" >ğŸ‘‰ ë§ì¹œ ê³„íší‘œë“¤ ë³´ëŸ¬ê°€ê¸°</a>
      <p><a href="" >ğŸ‘‰ ë‚´ ê³„íší‘œ ë§Œë“¤ëŸ¬ê°€ê¸°</a></p>
      <button class="close">âŒ</button>
    </div>
  </div>
  <div class="modal-overlay"></div>
</div>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
const canvas = document.getElementById('planCanvas');
const ctx = canvas.getContext('2d');
const width = canvas.width;
const height = canvas.height;
const centerX = width / 2;
const centerY = height / 2;
const radius = Math.min(width, height) * 0.3;
const hour24 = [
  { start: 0, end: 15, display: '06' },
  { start: 15, end: 30, display: '07' },
  { start: 30, end: 45, display: '08' },
  { start: 45, end: 60, display: '09' },
  { start: 60, end: 75, display: '10' },
  { start: 75, end: 90, display: '11' },
  { start: 90, end: 105, display: '12' },
  { start: 105, end: 120, display: '13' },
  { start: 120, end: 135, display: '14' },
  { start: 135, end: 150, display: '15' },
  { start: 150, end: 165, display: '16' },
  { start: 165, end: 180, display: '17' },
  { start: 180, end: 195, display: '18' },
  { start: 195, end: 210, display: '19' },
  { start: 210, end: 225, display: '20' },
  { start: 225, end: 240, display: '21' },
  { start: 240, end: 255, display: '22' },
  { start: 255, end: 270, display: '23' },
  { start: 270, end: 285, display: '24' },
  { start: 285, end: 300, display: '01' },
  { start: 300, end: 315, display: '02' },
  { start: 315, end: 330, display: '03' },
  { start: 330, end: 345, display: '04' },
  { start: 345, end: 360, display: '05' },
];

//ë‚´ë¶€ ì„ 
hour24.forEach(function(data){
    //ë‚´ë¶€ ì‹¤ì„  í‘œì‹œ
    ctx.save()
    ctx.beginPath()
    ctx.strokeStyle='#dfdfdf'
    ctx.lineWidth = 0.3
    ctx.moveTo(width/2, height/2)
    var xx = Math.cos(degreesToRadians(data.end)) * radius + width / 2
    var yy = Math.sin(degreesToRadians(data.end)) * radius + height / 2
    ctx.lineTo(xx,yy)
    ctx.stroke()
    //í…ìŠ¤íŠ¸(ì‹œê°„) í‘œì‹œ
    xx = Math.cos(degreesToRadians(data.end)) * radius*1.2 + width / 2
    yy = Math.sin(degreesToRadians(data.end)) * radius*1.2 + height / 2
    var minus = ctx.measureText(data.display).width / 2;
    ctx.fillText(data.display, xx-minus, yy)  //í…ìŠ¤íŠ¸ì˜ ê¸¸ì´ ë¹¼ ì£¼ê¸°
    ctx.closePath()       
    ctx.restore()         
})

//ê°ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ
function degreesToRadians(degrees) {
    const pi = Math.PI
    return degrees * (pi / 180)
}

// ìƒ‰ìƒ ì„ íƒ ì˜µì…˜ ìƒì„±
const colorSelect = document.getElementById('colorSelect');
const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
colors.forEach(color => {
  const option = document.createElement('option');
  option.value = color;
  option.textContent = color;
  colorSelect.appendChild(option);
});

let selectedColor = colors[0]; // ì´ˆê¸° ì„ íƒëœ ìƒ‰ìƒ (ì˜ˆì‹œë¡œ ë¹¨ê°• ì„ íƒ)

// ì„ íƒëœ ìƒ‰ìƒ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬
colorSelect.addEventListener('change', function(event) {
  selectedColor = event.target.value;
});

let doubleClickedCnt = 0;
const coloredSectors = [];
var min = 30;
var max = 0;

canvas.addEventListener('touchmove', function (event) {
  var touch = event.touches[0];
  var x1 = touch.clientX - canvas.parentElement.offsetLeft;
  var y1 = touch.clientY - canvas.parentElement.offsetTop;
  
  //coloredSectors ì´ˆê¸°í™”

  // í„°ì¹˜ ìœ„ì¹˜ì— ë”°ë¥¸ ë¶€ì±„ê¼´ ì˜ì—­ ì¸ë±ìŠ¤ ê³„ì‚°
  var angle = Math.atan2(y1 - centerY, x1 - centerX);
  var degree = ((angle * 180 / Math.PI) + 360) % 360;

  // ë¶€ì±„ê¼´ ì˜ì—­ë§Œ ë°°ê²½ìƒ‰ ë³€ê²½
  for (let i = 0; i < hour24.length; i++) {
    if (degree >= hour24[i].start && degree < hour24[i].end) {
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, (Math.PI / 180) * hour24[i].start, (Math.PI / 180) * hour24[i].end, false);
      ctx.fillStyle = selectedColor;
      ctx.fill();
      ctx.closePath();
      coloredSectors.push(i);
    }
  }
});

canvas.addEventListener('touchstart', function (event) {
    isUp = true
    setTimeout(function(){
        doubleClickedCnt++
    },100)        
})

canvas.addEventListener('touchend', function (event) {
    isUp = false
    uniqueSectors = [...new Set(coloredSectors)];
    uniqueSectors.forEach(function(index) {
      const sector = hour24[index];
      console.log('Colored sector:', sector);
      const temp = parseInt(sector.display)
      if(temp >= max){
        max = temp
      }

      if(temp <= min){
        min = temp
      }
    })
    console.log(min, max);

    coloredSectors.length = 0;

    //ë”ë¸”í´ë¦­
    setTimeout(function(){
        if(doubleClickedCnt > 1){
            var touch = event.changedTouches[0]
            var x1 = touch.clientX - canvas.parentElement.offsetLeft
            var y1 = touch.clientY - canvas.parentElement.offsetTop
            var inn = isInsideArc(x1, y1)
            // ì—¬ê¸°ì„œ ì›í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            
        }
        doubleClickedCnt = 0
    }, 250)    
})

canvas.addEventListener('mousemove', function(event) {
  var x1 = event.clientX - event.target.parentElement.offsetLeft;
  var y1 = event.clientY - event.target.parentElement.offsetTop;
  var inn = isInsideArc(x1, y1);
  console.log(inn);
});

function isInsideArc(x1, y1) {
  var result = false;
  var x = width / 2 - x1;
  var y = height / 2 - y1;
  var my_len = Math.sqrt(x * x + y * y);
  if (radius >= my_len) {
    result = true;
  }
  var rad = Math.atan2(y, x);
  rad = (rad * 180) / Math.PI;
  rad += 180;
  return { result: result, degree: rad };
}

function drawCircle(targets, first, last) {
  targets.save();
  targets.beginPath();
  targets.arc(
    width / 2,
    height / 2,
    radius,
    (Math.PI / 180) * first,
    (Math.PI / 180) * last,
    false
  );
  targets.lineWidth = 3;
  targets.strokeStyle = '#dfdfdf';
  targets.stroke();
  targets.closePath();
  targets.restore();
}

drawCircle(ctx, 0, 360, true);

/*modalì…ë‹ˆë‹¤~~*/
const addButton = document.getElementById('addButton');
addButton.addEventListener('click', showModal);

function showModal() {
  const modal = document.querySelector('.modal');
  modal.classList.remove('hidden');
}

const closeButton = document.querySelector('.close');
closeButton.addEventListener('click', closeModal);

function closeModal() {
  const modal = document.querySelector('.modal');
  modal.classList.add('hidden');
}

</script>
{%load static%}
<script src={% static "./js/timetable.js"%}></script>
{% endblock content %}