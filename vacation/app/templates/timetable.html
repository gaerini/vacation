{% extends 'base.html' %}

{% block css %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'timetableStyle.css' %}"/>
{% endblock css %}

{% block content %}
<div class="signinBox">
    <a href=""><button class="signinBtn">ë‚´ ê³„íší‘œ ë§Œë“¤ê¸°</button></a>
</div>
<div class="planCircleBox">
    <canvas id="planCanvas" width="380" height="400"></canvas>
    <button id="addButton">ì¶”ê°€</button>
    <input type="button" id="indexButton" onclick="showInput()">ì´ë²¤íŠ¸ ì¶”ê°€</button>
    <select id="colorSelect"></select>
</div>
<div class="makePlan">
    <div class="makePlanBox">
        <a href=""><button class="makePlanBtn">{{ username }}ì˜ ê³„íší‘œ ì§œì£¼ê¸°</button></a>
    </div>
</div>
<div class="planList">
    <div class="planListBox">
        <a href=""><button class="planListBtn">{{ username }}ì˜ ê³„íší‘œ í‰ê°€í•˜ê¸°</button></a>
    </div>
</div>
<div class="modal hidden">
  <div class="modal_content">
    <div class="modal_box">
      <h2>ê³„íší‘œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
      <img src=""/>
      <p>ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì´ ë§ì¹œ {{ username }} ê³„íší‘œë„ ë³´ëŸ¬ê°ˆê¹Œìš”~?</p>
      <a href="http://127.0.0.1:8000/tablelist/{{ timetable.pk }}" >ğŸ‘‰ ë§ì¹œ ê³„íší‘œë“¤ ë³´ëŸ¬ê°€ê¸°</a>
      <p><a href="" >ğŸ‘‰ ë‚´ ê³„íší‘œ ë§Œë“¤ëŸ¬ê°€ê¸°</a></p>
      <button class="close">âŒ</button>
    </div>
  </div>
  <div class="modal-overlay"></div>
</div>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
const canvas = document.getElementById('planCanvas');
const ctx = canvas.getContext('2d');
const width = canvas.width;
const height = canvas.height;
const centerX = width / 2;
const centerY = height / 2;
const radius = Math.min(width, height) * 0.3;
const hour24 = [
  { start: 0, end: 15, display: '07', fillColor: "#808080", index: ''},
  { start: 15, end: 30, display: '08', fillColor: "#808080", index: ''},
  { start: 30, end: 45, display: '09', fillColor: "#808080", index: ''},
  { start: 45, end: 60, display: '10', fillColor: "#808080", index: ''},
  { start: 60, end: 75, display: '11', fillColor: "#808080", index: ''},
  { start: 75, end: 90, display: '12', fillColor: "#808080", index: ''},
  { start: 90, end: 105, display: '13', fillColor: "#808080", index: ''},
  { start: 105, end: 120, display: '14', fillColor: "#808080", index: ''},
  { start: 120, end: 135, display: '15', fillColor: "#808080", index: ''},
  { start: 135, end: 150, display: '16', fillColor: "#808080", index: ''},
  { start: 150, end: 165, display: '17', fillColor: "#808080", index: ''},
  { start: 165, end: 180, display: '18', fillColor: "#808080", index: ''},
  { start: 180, end: 195, display: '19', fillColor: "#808080", index: ''},
  { start: 195, end: 210, display: '20', fillColor: "#808080", index: ''},
  { start: 210, end: 225, display: '21', fillColor: "#808080", index: ''},
  { start: 225, end: 240, display: '22', fillColor: "#808080", index: ''},
  { start: 240, end: 255, display: '23', fillColor: "#808080", index: ''},
  { start: 255, end: 270, display: '24', fillColor: "#808080", index: ''},
  { start: 270, end: 285, display: '01', fillColor: "#808080", index: ''},
  { start: 285, end: 300, display: '02', fillColor: "#808080", index: ''},
  { start: 300, end: 315, display: '03', fillColor: "#808080", index: ''},
  { start: 315, end: 330, display: '04', fillColor: "#808080", index: ''},
  { start: 330, end: 345, display: '05', fillColor: "#808080", index: ''},
  { start: 345, end: 360, display: '06', fillColor: "#808080", index: ''},
];

//ë‚´ë¶€ ì„ 
hour24.forEach(function(data){
    //ë‚´ë¶€ ì‹¤ì„  í‘œì‹œ
    ctx.save()
    ctx.beginPath()
    ctx.strokeStyle='#dfdfdf'
    ctx.lineWidth = 0.3
    ctx.moveTo(width/2, height/2)
    var xx = Math.cos(degreesToRadians(data.end)) * radius + width / 2
    var yy = Math.sin(degreesToRadians(data.end)) * radius + height / 2
    ctx.lineTo(xx,yy)
    ctx.stroke()
    //í…ìŠ¤íŠ¸(ì‹œê°„) í‘œì‹œ
    xx = Math.cos(degreesToRadians(data.end)) * radius*1.2 + width / 2
    yy = Math.sin(degreesToRadians(data.end)) * radius*1.2 + height / 2
    var minus = ctx.measureText(data.display).width / 2;
    ctx.fillText(data.display, xx-minus, yy)  //í…ìŠ¤íŠ¸ì˜ ê¸¸ì´ ë¹¼ ì£¼ê¸°
    ctx.closePath()       
    ctx.restore()         
})

//ê¸°ì¡´ ë°ì´í„° ì˜ì—­ ì¹ í•˜ê¸°
hour24.forEach(function(data) {
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, (Math.PI / 180) * data.start, (Math.PI / 180) * data.end, false);
    ctx.fillStyle = data.fillColor;
    ctx.fill();
    ctx.closePath();
  });


//ê°ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ
function degreesToRadians(degrees) {
    const pi = Math.PI
    return degrees * (pi / 180)
}

// ìƒ‰ìƒ ì„ íƒ ì˜µì…˜ ìƒì„±
const colorSelect = document.getElementById('colorSelect');
const colorAndDetail = [{detail: '', color: '#ff0000'},
                {detail: '', color: '#ff8c00'},
                {detail: '', color: '#ffff00'},
                {detail: '', color: '#008000'},
                {detail: '', color: '#0000ff'},
                {detail: '', color: '#4b0082'},
                {detail: '', color: '#800080'}];
colorAndDetail.forEach(obj => {
  const option = document.createElement('option');
  option.value = obj.color;
  option.textContent = obj.color;
  colorSelect.appendChild(option);
});

var initDetail = prompt('ì²« ê³„íšì´ ë­”ì§€ ì¨ì£¼ì„¸ìš©');
colorAndDetail[0].detail = initDetail;
let selectedColor = colorAndDetail[0].color; // ì´ˆê¸° ì„ íƒëœ ìƒ‰ìƒ (ì˜ˆì‹œë¡œ ë¹¨ê°• ì„ íƒ)
let selectedDetail = colorAndDetail[0].detail;
// ì„ íƒëœ ìƒ‰ìƒ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬
colorSelect.addEventListener('change', function(event) {
  colorAndDetail.forEach(function(obj){
    if (event.target.value == obj.color){
      if(obj.detail == ''){
        const initDetail = prompt('ì–´ë–¤ ê³„íšì„ ì ì–´ì¤„ì§€ ì…ë ¥í•´ì£¼ì„¸ìš”');
        obj.detail = initDetail;
        selectedColor = obj.color;
        selectedDetail = obj.detail;
      }

      else {
        selectedColor = obj.color;
        selectedDetail = obj.detail;
      }
    } 
    
  })

});

let doubleClickedCnt = 0;
const coloredSectors = [];
var min = 30;
var max = 0;

canvas.addEventListener('touchmove', function (event) {
  var touch = event.touches[0];
  var x1 = touch.clientX - canvas.parentElement.offsetLeft;
  var y1 = touch.clientY - canvas.parentElement.offsetTop;
  
  //coloredSectors ì´ˆê¸°í™”

  // í„°ì¹˜ ìœ„ì¹˜ì— ë”°ë¥¸ ë¶€ì±„ê¼´ ì˜ì—­ ì¸ë±ìŠ¤ ê³„ì‚°
  var angle = Math.atan2(y1 - centerY, x1 - centerX);
  var degree = ((angle * 180 / Math.PI) + 360) % 360;

  // ë¶€ì±„ê¼´ ì˜ì—­ë§Œ ë°°ê²½ìƒ‰ ë³€ê²½
  for (let i = 0; i < hour24.length; i++) {
    if (degree >= hour24[i].start && degree < hour24[i].end) {
      hour24[i].index = selectedDetail;
      hour24[i].fillColor = selectedColor;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, (Math.PI / 180) * hour24[i].start, (Math.PI / 180) * hour24[i].end, false);
      ctx.fillStyle = selectedColor;
      ctx.fill();
      
      ctx.closePath();
      coloredSectors.push(i);
      
    }
    
  }

});

canvas.addEventListener('touchstart', function (event) {
    isUp = true
    setTimeout(function(){
        doubleClickedCnt++
    },100)        
})

canvas.addEventListener('touchend', function (event) {
    isUp = false
    uniqueSectors = [...new Set(coloredSectors)];
    uniqueSectors.forEach(function(index) {
      const sector = hour24[index];
      console.log('Colored sector:', sector);
      const temp = parseInt(sector.display)
      if(temp >= max){
        max = temp
      }

      if(temp <= min){
        min = temp
      }
    })
    console.log(min, max);

    coloredSectors.length = 0;

    //ë”ë¸”í´ë¦­
    setTimeout(function(){
        if(doubleClickedCnt > 1){
            var touch = event.changedTouches[0]
            var x1 = touch.clientX - canvas.parentElement.offsetLeft
            var y1 = touch.clientY - canvas.parentElement.offsetTop
            var inn = isInsideArc(x1, y1)
            // ì—¬ê¸°ì„œ ì›í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            
        }
        doubleClickedCnt = 0
    }, 250)
    const detailText = textMaker();
})

canvas.addEventListener('mousemove', function(event) {
  var x1 = event.clientX - event.target.parentElement.offsetLeft;
  var y1 = event.clientY - event.target.parentElement.offsetTop;
  var inn = isInsideArc(x1, y1);
  console.log(inn);
});

function isInsideArc(x1, y1) {
  var result = false;
  var x = width / 2 - x1;
  var y = height / 2 - y1;
  var my_len = Math.sqrt(x * x + y * y);
  if (radius >= my_len) {
    result = true;
  }
  var rad = Math.atan2(y, x);
  rad = (rad * 180) / Math.PI;
  rad += 180;
  return { result: result, degree: rad };
}

function drawCircle(targets, first, last) {
  targets.save();
  targets.beginPath();
  targets.arc(
    width / 2,
    height / 2,
    radius,
    (Math.PI / 180) * first,
    (Math.PI / 180) * last,
    false
  );
  targets.lineWidth = 3;
  targets.strokeStyle = '#dfdfdf';
  targets.stroke();
  targets.closePath();
  targets.restore();
}

drawCircle(ctx, 0, 360, true);

function textMaker(){
  var copyArr = Object.assign([], hour24)  //ë°°ì—´ ë³µì‚¬
  var summery = []
  var eq = ''
  var start = -1
  var colors = ''
  copyArr.forEach(function(data, idx){
      if(idx == 0){  //ê°€ì¥ ì²˜ìŒì´ë©´
          eq = data.index
          start = data.start
          colors = data.fillColor
      } else if(eq != data.index){   //ì¸ë±ìŠ¤ê°€ ë‹¤ë¥´ë©´             
          summery.push({start : start, end : data.start, index : eq, fillColor: colors})
          eq = data.index
          start = data.start
          colors =  data.fillColor
          if(idx == copyArr.length-1){  //ì¸ë±ìŠ¤ê°€ ë‹¤ë¥´ë©´ì„œ ë§ˆì§€ë§‰ì´ë©´
              summery.push({start : start, end : data.end, index : eq, fillColor: data.fillColor})
          }                
      } else if(idx == copyArr.length-1){ //ë§ˆì§€ë§‰ì´ë©´
          summery.push({start : start, end : data.start, index : eq, filledColor: data.filledColor})
      }
  })

  var lastCheck = summery[0]
  var lastCheck2 = summery[summery.length-1]
  
  if(lastCheck.index == lastCheck2.index) {  //ë§ˆì§€ë§‰ ìŠ¤íƒ€íŠ¸ê°€ ì²˜ìŒ ìŠ¤íƒ€íŠ¸ë¡œ ì˜¤ë„ë¡ ë³€ê²½ í•©ë‹ˆë‹¤.
      summery[0].start = lastCheck2.start
      summery.pop()
  }      
  console.log(summery);
  summery.forEach(function(data){
      if(data.index != ''){  //ìŠ¤ì¼€ì¤„ì´ ë“±ë¡ëœ ê²½ìš°ë§Œ ê·¸ë¦¬ê²Œ í•©ë‹ˆë‹¤.
          var half = Math.abs(data.end - data.start) / 2  //ë¶€ì±„ê¼´ í¬ê¸°ì˜ ì ˆë°˜ì…ë‹ˆë‹¤.
          
          if(data.start > data.end ){ //ë§ˆì§€ë§‰ ê°ë„ê°€ 0ë„ê°€ ë„˜ì–´ê°„ ê²½ìš° ì…ë‹ˆë‹¤.
              half = (360-data.start + data.end) / 2
          }
          var degg = data.start + half;
          var xx = Math.cos(degreesToRadians(degg)) * radius * 0.7 + width / 2;
          var yy = Math.sin(degreesToRadians(degg)) * radius * 0.7 + height / 2;
          ctx.save()
          ctx.beginPath()
          ctx.fillStyle = 'white'
          ctx.fillText(data.index, xx, yy)
          ctx.restore()
      }
  })           
}
/*modalì…ë‹ˆë‹¤~~*/
const addButton = document.getElementById('addButton');
addButton.addEventListener('click', showModal);

function showModal() {
  const modal = document.querySelector('.modal');
  modal.classList.remove('hidden');
}

const closeButton = document.querySelector('.close');
closeButton.addEventListener('click', closeModal);

function closeModal() {
  const modal = document.querySelector('.modal');
  modal.classList.add('hidden');
}

</script>
{%load static%}
<script src={% static "./js/timetable.js"%}></script>
{% endblock content %}